<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Migrating from the hashi_vault lookup &mdash; Ansible collections  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/ansible.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/antsibull-minimal.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/rtd-ethical-ads.css" type="text/css" />
    <link rel="shortcut icon" href="_static/images/Ansible-Mark-RGB_Black.svg"/>
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="About the hashi_vault lookup" href="about_hashi_vault_lookup.html" />
    <link rel="prev" title="User guide" href="user_guide.html" /><!-- extra head elements for Ansible beyond RTD Sphinx Theme -->




</head>

<body class="wy-body-for-nav"><!-- extra body elements for Ansible beyond RTD Sphinx Theme -->

<div class="DocSite-globalNav ansibleNav">
  <ul>
    <li><a href="https://www.ansible.com/ansiblefest" target="_blank">AnsibleFest</a></li>
    <li><a href="https://www.ansible.com/tower" target="_blank">Products</a></li>
    <li><a href="https://www.ansible.com/community" target="_blank">Community</a></li>
    <li><a href="https://www.ansible.com/webinars-training" target="_blank">Webinars & Training</a></li>
    <li><a href="https://www.ansible.com/blog" target="_blank">Blog</a></li>
  </ul>
</div>

<a class="DocSite-nav" href="/" style="padding-bottom: 30px;">

  <img class="DocSiteNav-logo"
    src="../../../../_static/images/Ansible-Mark-RGB_White.svg"
    alt="Ansible Logo">
  <div class="DocSiteNav-title">Ansible Collections Documentation</div>
</a>
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> Ansible collections
          </a><!--- Based on https://github.com/rtfd/sphinx_rtd_theme/pull/438/files -->

<div class="version">
  
    
  
</div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" class="st-default-search-input" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
              <p class="caption" role="heading"><span class="caption-text">Collections:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Collection Index</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">Collections in the Community Namespace</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Community.Hashi_Vault</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../index.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#communication">Communication</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="../index.html#guides">Guides</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#plugin-index">Plugin Index</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Plugin indexes:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index_lookup.html">Index of all Lookup Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../index_module.html">Index of all Modules</a></li>
</ul>
<!-- extra nav elements for Ansible beyond RTD Sphinx Theme -->

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Ansible collections</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Collection Index</a> &raquo;</li>
          <li><a href="../../index.html">Collections in the Community Namespace</a> &raquo;</li>
          <li><a href="../index.html">Community.Hashi_Vault</a> &raquo;</li>
      <li>Migrating from the <code class="docutils literal notranslate"><span class="pre">hashi_vault</span></code> lookup</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">

  
           <div itemprop="articleBody">
             
  <section id="migrating-from-the-hashi-vault-lookup">
<span id="ansible-collections-community-hashi-vault-docsite-migration-hashi-vault-lookup"></span><h1>Migrating from the <code class="docutils literal notranslate"><span class="pre">hashi_vault</span></code> lookup<a class="headerlink" href="#migrating-from-the-hashi-vault-lookup" title="Permalink to this headline"></a></h1>
<p>This is a guide for migrating from the <code class="docutils literal notranslate"><span class="pre">hashi_vault</span></code> <a class="reference internal" href="../hashi_vault_lookup.html#ansible-collections-community-hashi-vault-hashi-vault-lookup"><span class="std std-ref">lookup plugin</span></a> to newer content in this collection.</p>
<p>To understand why, please see <a class="reference internal" href="about_hashi_vault_lookup.html#ansible-collections-community-hashi-vault-docsite-about-hashi-vault-lookup"><span class="std std-ref">this page describing the plugin’s history and future</span></a>.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#a-note-about-lookups-vs-modules" id="id1">A note about lookups vs. modules</a></p></li>
<li><p><a class="reference internal" href="#general-changes" id="id2">General changes</a></p>
<ul>
<li><p><a class="reference internal" href="#options-direct-vs-term-string" id="id3">Options: direct vs. term string</a></p></li>
<li><p><a class="reference internal" href="#key-dereferencing" id="id4">Key dereferencing</a></p></li>
<li><p><a class="reference internal" href="#return-format" id="id5">Return format</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#vault-kv-reads" id="id6">Vault KV reads</a></p>
<ul>
<li><p><a class="reference internal" href="#kv1-and-kv2-response-structure" id="id7">KV1 and KV2 response structure</a></p></li>
<li><p><a class="reference internal" href="#kv1-and-kv2-api-paths" id="id8">KV1 and KV2 API paths</a></p></li>
<li><p><a class="reference internal" href="#kv2-secret-vesions" id="id9">KV2 secret vesions</a></p></li>
<li><p><a class="reference internal" href="#kv-get-replacements" id="id10">KV get replacements</a></p></li>
<li><p><a class="reference internal" href="#examples" id="id11">Examples</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#general-reads-non-kv" id="id12">General reads (non-KV)</a></p></li>
</ul>
</div>
<section id="a-note-about-lookups-vs-modules">
<h2><a class="toc-backref" href="#id1">A note about lookups vs. modules</a><a class="headerlink" href="#a-note-about-lookups-vs-modules" title="Permalink to this headline"></a></h2>
<p>Since the <code class="docutils literal notranslate"><span class="pre">hashi_vault</span></code> plugin is a lookup, it is often most straightforward to replace its use with other lookups. There was no module option available previously, however there is now.</p>
<p>Although it may be more involved, consider each use case to determine if a module is more appropriate.</p>
<p>For more information, see the <a class="reference internal" href="lookup_guide.html#ansible-collections-community-hashi-vault-docsite-lookup-guide"><span class="std std-ref">lookup guide</span></a>.</p>
</section>
<section id="general-changes">
<h2><a class="toc-backref" href="#id2">General changes</a><a class="headerlink" href="#general-changes" title="Permalink to this headline"></a></h2>
<p>This section will cover some general differences not related to specific scenarios.</p>
<section id="options-direct-vs-term-string">
<h3><a class="toc-backref" href="#id3">Options: direct vs. term string</a><a class="headerlink" href="#options-direct-vs-term-string" title="Permalink to this headline"></a></h3>
<p>For a long time, the <code class="docutils literal notranslate"><span class="pre">hashi_vault</span></code> lookup took all of its options as <code class="docutils literal notranslate"><span class="pre">name=value</span></code> strings inside the term string, so you would do a lookup with a single string that looked something like <code class="docutils literal notranslate"><span class="pre">secret/data/path</span> <span class="pre">auth_method=userpass</span> <span class="pre">username=my_user</span> <span class="pre">password=somepass</span></code>.</p>
<p>This way of passing options is discouraged, and <code class="docutils literal notranslate"><span class="pre">hashi_vault</span></code> was updated (before this collection existed) to support passing options as individual keyword arguments. The term string method was kept for backward compatibility.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>None of the other lookups in this collection will support the old style term string syntax, so changing to direct options is highly recommended.</p>
</div>
<p>If your existing lookups use options in the term string, you may want to first change to direct use of options before trying to change the plugin, <strong>especially if you intend to continue using lookups instead of modules</strong>.</p>
<p>Examples of the term string style:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Term string style</span><span class="w"></span>
<span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my_user</span><span class="w"></span>
<span class="w">    </span><span class="nt">pass</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;</span><span class="cp">{{</span> <span class="nv">my_secret_password</span> <span class="cp">}}</span><span class="s">&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">mount</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret</span><span class="w"></span>
<span class="w">    </span><span class="nt">relpath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">path</span><span class="w"></span>
<span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;Static:</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;secret/data/path auth_method=userpass username=my_user password=somepass&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;Variables:</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="nv">mount</span> <span class="o">~</span> <span class="s1">&#39;/data/&#39;</span> <span class="o">~</span> <span class="nv">path</span> <span class="o">~</span> <span class="s1">&#39; auth_method=userpass username=&#39;</span> <span class="o">~</span> <span class="nv">user</span> <span class="o">~</span> <span class="s1">&#39; password=&#39;</span> <span class="o">~</span> <span class="nv">pass</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="c1">#                                          note these necessary but easy to miss spaces ^                                          ^</span><span class="w"></span>
</pre></div>
</div>
<p>And the same lookups converted to direct options:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Direct option style</span><span class="w"></span>
<span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my_user</span><span class="w"></span>
<span class="w">    </span><span class="nt">pass</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;</span><span class="cp">{{</span> <span class="nv">my_secret_password</span> <span class="cp">}}</span><span class="s">&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">mount</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret</span><span class="w"></span>
<span class="w">    </span><span class="nt">relpath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">path</span><span class="w"></span>
<span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;Static:</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;secret/data/path&#39;</span><span class="o">,</span> <span class="nv">auth_method</span><span class="o">=</span><span class="s1">&#39;userpass&#39;</span><span class="o">,</span> <span class="nv">username</span><span class="o">=</span><span class="s1">&#39;my_user&#39;</span><span class="o">,</span> <span class="nv">password</span><span class="o">=</span><span class="s1">&#39;somepass&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;Variables:</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="nv">mount</span> <span class="o">~</span> <span class="s1">&#39;/data/&#39;</span> <span class="o">~</span> <span class="nv">path</span><span class="o">,</span> <span class="nv">auth_method</span><span class="o">=</span><span class="s1">&#39;userpass&#39;</span><span class="o">,</span> <span class="nv">username</span><span class="o">=</span><span class="nv">user</span><span class="o">,</span> <span class="nv">password</span><span class="o">=</span><span class="nv">pass</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="key-dereferencing">
<h3><a class="toc-backref" href="#id4">Key dereferencing</a><a class="headerlink" href="#key-dereferencing" title="Permalink to this headline"></a></h3>
<p>For these examples we will assume our result dictionary has this structure:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">key_1</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">value1</span><span class="w"></span>
<span class="s">&#39;key-2&#39;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"></span>
<span class="s">&#39;key</span><span class="nv"> </span><span class="s">three&#39;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">three</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">hashi_vault</span></code> also supported a dictionary dereferencing syntax with colon <code class="docutils literal notranslate"><span class="pre">:</span></code>, so it was common to see this:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(key1):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv1_mount/path/to/secret:key_1&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV2</span><span class="nv"> </span><span class="s">(key1):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv2_mount/data/path/to/secret:key_1&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
</pre></div>
</div>
<p>With the above syntax, only the <em>value</em> of <code class="docutils literal notranslate"><span class="pre">key_1</span></code> is returned. Note that <code class="docutils literal notranslate"><span class="pre">key</span> <span class="pre">three</span></code> could not have been retrieved this way, because the space was the delimiter for the term string options.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The colon <code class="docutils literal notranslate"><span class="pre">:</span></code> syntax is not supported in any other lookups in the collection, and its use is discouraged.</p>
</div>
<p><strong>Colon</strong> <code class="docutils literal notranslate"><span class="pre">:</span></code> <strong>use does not correspond to any server-side filtering or other optimization</strong>, so other than compact syntax there is there no advantage to using it.</p>
<p>The colon <code class="docutils literal notranslate"><span class="pre">:</span></code> syntax could always have been replaced by directly dereferencing in the Jinja2 template. Direct dereferencing can be done with the Jinja2 dot <code class="docutils literal notranslate"><span class="pre">.</span></code> syntax (which has restrictions on the key names) or via square brackets <code class="docutils literal notranslate"><span class="pre">[]</span></code>, like so (KV version does not matter):</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">vars</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">k1</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">key_1</span><span class="w"></span>
<span class="w">    </span><span class="nt">k2</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">key-2</span><span class="w"></span>
<span class="w">    </span><span class="nt">k3</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">key three</span><span class="w"></span>
<span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(key1,</span><span class="nv"> </span><span class="s">dot):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv1_mount/path/to/secret&#39;</span><span class="o">)</span><span class="nv">.key_1</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(key1,</span><span class="nv"> </span><span class="s">[</span><span class="nv"> </span><span class="s">]):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv1_mount/path/to/secret&#39;</span><span class="o">)[</span><span class="s1">&#39;key_1&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(var1,</span><span class="nv"> </span><span class="s">[</span><span class="nv"> </span><span class="s">]):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv1_mount/path/to/secret&#39;</span><span class="o">)[</span><span class="nv">k1</span><span class="o">]</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(key2,</span><span class="nv"> </span><span class="s">[</span><span class="nv"> </span><span class="s">]):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv1_mount/path/to/secret&#39;</span><span class="o">)[</span><span class="s1">&#39;key-2&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(var2,</span><span class="nv"> </span><span class="s">[</span><span class="nv"> </span><span class="s">]):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv1_mount/path/to/secret&#39;</span><span class="o">)[</span><span class="nv">k2</span><span class="o">]</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(key3,</span><span class="nv"> </span><span class="s">[</span><span class="nv"> </span><span class="s">]):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv1_mount/path/to/secret&#39;</span><span class="o">)[</span><span class="s1">&#39;key three&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(var3,</span><span class="nv"> </span><span class="s">[</span><span class="nv"> </span><span class="s">]):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv1_mount/path/to/secret&#39;</span><span class="o">)[</span><span class="nv">k3</span><span class="o">]</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
</pre></div>
</div>
<p>Note that only <code class="docutils literal notranslate"><span class="pre">key_1</span></code> could use the dot <code class="docutils literal notranslate"><span class="pre">.</span></code> syntax because the allowed characters for that are limited to those allowed for Python symbols. Variables also cannot be used with dot <code class="docutils literal notranslate"><span class="pre">.</span></code> access.</p>
<p>Furthermore, the colon <code class="docutils literal notranslate"><span class="pre">:</span></code> syntax encouraged multiple lookups to the same secret only for the purpose of getting different keys, leading to multiple identical requests to Vault. <strong>The above example also suffers from this</strong>.</p>
<p>A more DRY approach might look like this:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">vars</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv1_mount/path/to/secret&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">k1</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">key_1</span><span class="w"></span>
<span class="w">    </span><span class="nt">k2</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">key-2</span><span class="w"></span>
<span class="w">    </span><span class="nt">k3</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">key three</span><span class="w"></span>
<span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(key1,</span><span class="nv"> </span><span class="s">dot):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">secret.key_1</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(key1,</span><span class="nv"> </span><span class="s">[</span><span class="nv"> </span><span class="s">]):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">secret</span><span class="o">[</span><span class="s1">&#39;key_1&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(var1,</span><span class="nv"> </span><span class="s">[</span><span class="nv"> </span><span class="s">]):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">secret</span><span class="o">[</span><span class="nv">k1</span><span class="o">]</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(key2,</span><span class="nv"> </span><span class="s">[</span><span class="nv"> </span><span class="s">]):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">secret</span><span class="o">[</span><span class="s1">&#39;key-2&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(var2,</span><span class="nv"> </span><span class="s">[</span><span class="nv"> </span><span class="s">]):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">secret</span><span class="o">[</span><span class="nv">k2</span><span class="o">]</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(key3,</span><span class="nv"> </span><span class="s">[</span><span class="nv"> </span><span class="s">]):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">secret</span><span class="o">[</span><span class="s1">&#39;key three&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(var3,</span><span class="nv"> </span><span class="s">[</span><span class="nv"> </span><span class="s">]):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">secret</span><span class="o">[</span><span class="nv">k3</span><span class="o">]</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
</pre></div>
</div>
<p>This looks a lot better, and it is from a readability perspective, but <strong>in fact it will operate exactly the same way</strong>, making a new request on every reference to <code class="docutils literal notranslate"><span class="pre">secret</span></code>. This is due to lazy template evaluation in Ansible, and is discussed in more detail in the <a class="reference internal" href="lookup_guide.html#ansible-collections-community-hashi-vault-docsite-lookup-guide"><span class="std std-ref">lookup guide</span></a>. This can be remedied by either using <code class="docutils literal notranslate"><span class="pre">ansible.builtin.set_fact</span></code> to set the <code class="docutils literal notranslate"><span class="pre">secret</span></code> variable, or by using a module to do the read.</p>
<p>If you have extensive use of the colon <code class="docutils literal notranslate"><span class="pre">:</span></code> syntax, updating it before moving onto other plugins is recommended.</p>
</section>
<section id="return-format">
<h3><a class="toc-backref" href="#id5">Return format</a><a class="headerlink" href="#return-format" title="Permalink to this headline"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">return_format</span></code> option will not be supported in other plugins. It is recommended to replace it with Jinja2 if you are using it currently.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">hashi_vault</span></code> lookup takes a <code class="docutils literal notranslate"><span class="pre">return_format</span></code> option that defaults to <code class="docutils literal notranslate"><span class="pre">dict</span></code>. The lookup always looks for a <code class="docutils literal notranslate"><span class="pre">data</span></code> field (see the <a class="reference internal" href="#ansible-collections-community-hashi-vault-docsite-migration-hashi-vault-lookup-kv-response"><span class="std std-ref">KV response details</span></a> for more information), and that is what is returned by default.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">raw</span></code> value for <code class="docutils literal notranslate"><span class="pre">return_format</span></code> gives the raw API response from the request. This can be used to get the metadata from a KV2 request for example, which is usually stripped off, or it can be used to read from a non-KV path whose response happens to look like a KV response (with one or more <code class="docutils literal notranslate"><span class="pre">data</span></code> structures), and gets interpreted as one as a result.</p>
<p>For reading non-KV paths <a class="reference internal" href="#ansible-collections-community-hashi-vault-docsite-migration-hashi-vault-lookup-non-kv-replacements"><span class="std std-ref">other options are available</span></a>.</p>
<p>For getting access to KV2 metadata, see the section on <a class="reference internal" href="#ansible-collections-community-hashi-vault-docsite-migration-hashi-vault-lookup-kv-replacements"><span class="std std-ref">KV replacements</span></a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">return_format</span></code> option can also be set to <code class="docutils literal notranslate"><span class="pre">values</span></code> to return a list of the dictionary’s values.</p>
<p>This can be replaced with Jinja2. We will use our example secret again:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">key_1</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">value1</span><span class="w"></span>
<span class="s">&#39;key-2&#39;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"></span>
<span class="s">&#39;key</span><span class="nv"> </span><span class="s">three&#39;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">three</span><span class="w"></span>
</pre></div>
</div>
<p>And look at uses with <code class="docutils literal notranslate"><span class="pre">return_format</span></code>:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="c1"># show a list of values, [&#39;value1&#39;, 2, &#39;three&#39;]</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1:</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv1_mount/path/to/secret&#39;</span><span class="o">,</span> <span class="nv">return_format</span><span class="o">=</span><span class="s1">&#39;values&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>

<span class="c1"># run debug once for each value</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">query</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv1_mount/path/to/secret&#39;</span><span class="o">,</span> <span class="nv">return_format</span><span class="o">=</span><span class="s1">&#39;values&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
</pre></div>
</div>
<p>We can do the same with Jinja2:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="c1"># show a list of values</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1:</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv1_mount/path/to/secret&#39;</span><span class="o">)</span><span class="nv">.values</span><span class="o">()</span> <span class="o">|</span> <span class="nf">list</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>

<span class="c1"># run debug once for each value</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv1_mount/path/to/secret&#39;</span><span class="o">)</span><span class="nv">.values</span><span class="o">()</span> <span class="o">|</span> <span class="nf">list</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="vault-kv-reads">
<h2><a class="toc-backref" href="#id6">Vault KV reads</a><a class="headerlink" href="#vault-kv-reads" title="Permalink to this headline"></a></h2>
<p>The most common use for the <code class="docutils literal notranslate"><span class="pre">hashi_vault</span></code> lookup is reading secrets from the KV secret store.</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1:</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv1_mount/path/to/secret&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV2:</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv2_mount/data/path/to/secret&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
</pre></div>
</div>
<p>The return value of both of those is the dictionary of the key/value pairs in the secret, with no additional information from the API response, nor the metadata (in the case of KV2).</p>
<section id="kv1-and-kv2-response-structure">
<span id="ansible-collections-community-hashi-vault-docsite-migration-hashi-vault-lookup-kv-response"></span><h3><a class="toc-backref" href="#id7">KV1 and KV2 response structure</a><a class="headerlink" href="#kv1-and-kv2-response-structure" title="Permalink to this headline"></a></h3>
<p>Under the hood, the return format of version 1 and version 2 of the KV store differs.</p>
<p>Here is a sample KV1 response:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;auth&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;Key1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;val1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;Key2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;val2&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;lease_duration&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2764800</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;lease_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;renewable&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;request_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;e26a7521-e512-82f1-3998-7cc494f14e86&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;warnings&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;wrap_info&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>And a sample KV2 response:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;auth&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;Key1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;val1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;Key2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;val2&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;metadata&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;created_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-04-21T15:56:58.8525402Z&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;custom_metadata&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;deletion_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;destroyed&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;lease_duration&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;lease_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;renewable&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;request_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;15538d55-0ad9-1c39-2f4b-dcbb982f13cc&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;warnings&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;wrap_info&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">hashi_vault</span></code> lookup traditionally returned the <code class="docutils literal notranslate"><span class="pre">data</span></code> field of whatever it was reading, and then later the plugin was updated to its current behavior, where it looks for the nested <code class="docutils literal notranslate"><span class="pre">data.data</span></code> structure, and if found, it returns only the inner <code class="docutils literal notranslate"><span class="pre">data</span></code>. This aims to always return the secret data from KV1 and KV2 in a consistent format, but it means any additional information from KV2’s metadata could not be accessed.</p>
</section>
<section id="kv1-and-kv2-api-paths">
<h3><a class="toc-backref" href="#id8">KV1 and KV2 API paths</a><a class="headerlink" href="#kv1-and-kv2-api-paths" title="Permalink to this headline"></a></h3>
<p>KV1’s API path had the secret paths directly concatenated to the mount point. So for example, if a KV1 engine is mounted at <code class="docutils literal notranslate"><span class="pre">kv/v/1</span></code> (mount paths can contain <code class="docutils literal notranslate"><span class="pre">/</span></code>), and a secret was created in that store at <code class="docutils literal notranslate"><span class="pre">app/deploy_key</span></code>, the path would be <code class="docutils literal notranslate"><span class="pre">kv/v/1/app/deploy_key</span></code>.</p>
<p>In KV2, there are separate paths that deal with the data and the metadata of a secret, so an additional <code class="docutils literal notranslate"><span class="pre">/data/</span></code> or <code class="docutils literal notranslate"><span class="pre">/metadata/</span></code> component needs to be inserted between the mount and the path.</p>
<p>For example with a KV2 store mounted at <code class="docutils literal notranslate"><span class="pre">kv/v/2</span></code>, and a secret at <code class="docutils literal notranslate"><span class="pre">app/deploy_key</span></code>, the path to read the secret data is <code class="docutils literal notranslate"><span class="pre">kv/v/2/data/app/deploy_key</span></code>. For metadata operations it would be <code class="docutils literal notranslate"><span class="pre">kv/v/2/metadata/app/deploy_key</span></code>.</p>
<p>Since <code class="docutils literal notranslate"><span class="pre">hashi_vault</span></code> does a generic read to an API path, anyone using it must know to insert those into the path, which causes a lot of confusion.</p>
</section>
<section id="kv2-secret-vesions">
<h3><a class="toc-backref" href="#id9">KV2 secret vesions</a><a class="headerlink" href="#kv2-secret-vesions" title="Permalink to this headline"></a></h3>
<p>Since KV2 is a versioned secret store, multiple versions of the same secret usually exist. There was no dedicated way to get anything but the latest secret (default) with the <code class="docutils literal notranslate"><span class="pre">hashi_vault</span></code> lookup, but docs suggested that <code class="docutils literal notranslate"><span class="pre">?version=2</span></code> could be added to the path to get secret version 2. This did work but it directly modified the API path, so it was not considered a stable option. The dedicated KV2 content in the collection supports this as a first class option.</p>
</section>
<section id="kv-get-replacements">
<span id="ansible-collections-community-hashi-vault-docsite-migration-hashi-vault-lookup-kv-replacements"></span><h3><a class="toc-backref" href="#id10">KV get replacements</a><a class="headerlink" href="#kv-get-replacements" title="Permalink to this headline"></a></h3>
<p>As of collection version 2.5.0, the <code class="docutils literal notranslate"><span class="pre">vault_kv1_get</span></code> and <code class="docutils literal notranslate"><span class="pre">vault_kv2_get</span></code> lookups and modules were added:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">vault_kv1_get</span></code> <a class="reference internal" href="../vault_kv1_get_lookup.html#ansible-collections-community-hashi-vault-vault-kv1-get-lookup"><span class="std std-ref">lookup</span></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vault_kv2_get</span></code> <a class="reference internal" href="../vault_kv2_get_lookup.html#ansible-collections-community-hashi-vault-vault-kv2-get-lookup"><span class="std std-ref">lookup</span></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vault_kv1_get</span></code> <a class="reference internal" href="../vault_kv1_get_module.html#ansible-collections-community-hashi-vault-vault-kv1-get-module"><span class="std std-ref">module</span></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vault_kv2_get</span></code> <a class="reference internal" href="../vault_kv2_get_module.html#ansible-collections-community-hashi-vault-vault-kv2-get-module"><span class="std std-ref">module</span></a></p></li>
</ul>
</div></blockquote>
<p>These dedicated plugins clearly separate KV1 and KV2 operations. This ensures their behavior is clear and predictable.</p>
<p>As it relates to API paths, these plugins take the approach of most Vault client libraries, and recommended by HashiCorp, which is to accept the mount point as an option (<code class="docutils literal notranslate"><span class="pre">engine_mount_point</span></code>), separate from the path to be read. This ensures a proper path will be constructed internally, and does not require the caller to insert <code class="docutils literal notranslate"><span class="pre">/data/</span></code> on KV2.</p>
<p>For return values, the KV plugins no longer return a direct secret. Instead, the return values from KV1 and KV2, and both the module and lookup forms, have been unified to give easy access to the secret, the full API response, and other parts of the response discretely.</p>
<p>The return values are covered directly in the documentation for each plugin in the return and examples sections.</p>
</section>
<section id="examples">
<h3><a class="toc-backref" href="#id11">Examples</a><a class="headerlink" href="#examples" title="Permalink to this headline"></a></h3>
<p>Here are some before and after KV examples.</p>
<p>We will go back to our sample secret:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">key_1</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">value1</span><span class="w"></span>
<span class="s">&#39;key-2&#39;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"></span>
<span class="s">&#39;key</span><span class="nv"> </span><span class="s">three&#39;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">three</span><span class="w"></span>
</pre></div>
</div>
<p>And some usage:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Reading secrets with hashi_vault and colon dereferencing</span><span class="w"></span>
<span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(key1):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv1_mount/path/to/secret:key_1&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV2</span><span class="nv"> </span><span class="s">(key1):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv2_mount/data/path/to/secret:key_1&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Replacing the above</span><span class="w"></span>
<span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV1</span><span class="nv"> </span><span class="s">(key1):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.vault_kv1_get&#39;</span><span class="o">,</span> <span class="s1">&#39;path/to/secret&#39;</span><span class="o">,</span> <span class="nv">engine_mount_point</span><span class="o">=</span><span class="s1">&#39;kv1_mount&#39;</span><span class="o">)</span><span class="nv">.secret.key_1</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV2</span><span class="nv"> </span><span class="s">(key1):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.vault_kv2_get&#39;</span><span class="o">,</span> <span class="s1">&#39;path/to/secret&#39;</span><span class="o">,</span> <span class="nv">engine_mount_point</span><span class="o">=</span><span class="s1">&#39;kv2_mount&#39;</span><span class="o">)</span><span class="nv">.secret.key_1</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Reading secret version 7 (old)</span><span class="w"></span>
<span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV2</span><span class="nv"> </span><span class="s">(v7):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv2_mount/data/path/to/secret?version=7&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Reading secret version 7 (new)</span><span class="w"></span>
<span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV2</span><span class="nv"> </span><span class="s">(v7):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.vault_kv2_get&#39;</span><span class="o">,</span> <span class="s1">&#39;path/to/secret&#39;</span><span class="o">,</span> <span class="nv">engine_mount_point</span><span class="o">=</span><span class="s1">&#39;kv2_mount&#39;</span><span class="o">,</span> <span class="nv">version</span><span class="o">=</span><span class="m">7</span><span class="o">)</span><span class="nv">.secret</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Reading KV2 metadata (old)</span><span class="w"></span>
<span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV2</span><span class="nv"> </span><span class="s">(metadata):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.hashi_vault&#39;</span><span class="o">,</span> <span class="s1">&#39;kv2_mount/data/path/to/secret&#39;</span><span class="o">,</span> <span class="nv">return_format</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="o">)</span><span class="nv">.data.metadata</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Reading KV2 metadata (new)</span><span class="w"></span>
<span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;KV2</span><span class="nv"> </span><span class="s">(metadata):</span><span class="nv"> </span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.vault_kv2_get&#39;</span><span class="o">,</span> <span class="s1">&#39;path/to/secret&#39;</span><span class="o">,</span> <span class="nv">engine_mount_point</span><span class="o">=</span><span class="s1">&#39;kv2_mount&#39;</span><span class="o">)</span><span class="nv">.metadata</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="general-reads-non-kv">
<span id="ansible-collections-community-hashi-vault-docsite-migration-hashi-vault-lookup-non-kv-replacements"></span><h2><a class="toc-backref" href="#id12">General reads (non-KV)</a><a class="headerlink" href="#general-reads-non-kv" title="Permalink to this headline"></a></h2>
<p>Since the <code class="docutils literal notranslate"><span class="pre">hashi_vault</span></code> lookup does a generic read internally, it can be used to read other paths that are not KV-specifc, for example reading from a cubbyhole or retrieving an AppRole’s role ID.</p>
<p>More specific-purpose content is expected in the future, for example plugins for retrieving a role ID, but for anything not covered right now, we have the <code class="docutils literal notranslate"><span class="pre">vault_read</span></code> lookup and module:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">vault_read</span></code> <a class="reference internal" href="../vault_read_lookup.html#ansible-collections-community-hashi-vault-vault-read-lookup"><span class="std std-ref">lookup</span></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vault_read</span></code> <a class="reference internal" href="../vault_read_module.html#ansible-collections-community-hashi-vault-vault-read-module"><span class="std std-ref">module</span></a></p></li>
</ul>
</div></blockquote>
<p>These always do a direct read, and return a raw result, without trying to do any additional interpretation of the response. See their documentation for examples.</p>
</section>
</section>


           </div>
          </div>
          

<footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="user_guide.html" class="btn btn-neutral float-left" title="User guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="about_hashi_vault_lookup.html" class="btn btn-neutral float-right" title="About the hashi_vault lookup" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ansible contributors.</p>
  </div>

  
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script><!-- extra footer elements for Ansible beyond RTD Sphinx Theme -->

</body>
</html>