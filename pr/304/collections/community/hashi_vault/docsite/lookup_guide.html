<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lookup guide &mdash; Ansible collections  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/ansible.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/antsibull-minimal.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/rtd-ethical-ads.css" type="text/css" />
    <link rel="shortcut icon" href="_static/images/Ansible-Mark-RGB_Black.svg"/>
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Contributor guide" href="contributor_guide.html" />
    <link rel="prev" title="About the hashi_vault lookup" href="about_hashi_vault_lookup.html" /><!-- extra head elements for Ansible beyond RTD Sphinx Theme -->




</head>

<body class="wy-body-for-nav"><!-- extra body elements for Ansible beyond RTD Sphinx Theme -->

<div class="DocSite-globalNav ansibleNav">
  <ul>
    <li><a href="https://www.ansible.com/ansiblefest" target="_blank">AnsibleFest</a></li>
    <li><a href="https://www.ansible.com/tower" target="_blank">Products</a></li>
    <li><a href="https://www.ansible.com/community" target="_blank">Community</a></li>
    <li><a href="https://www.ansible.com/webinars-training" target="_blank">Webinars & Training</a></li>
    <li><a href="https://www.ansible.com/blog" target="_blank">Blog</a></li>
  </ul>
</div>

<a class="DocSite-nav" href="/" style="padding-bottom: 30px;">

  <img class="DocSiteNav-logo"
    src="../../../../_static/images/Ansible-Mark-RGB_White.svg"
    alt="Ansible Logo">
  <div class="DocSiteNav-title">Ansible Collections Documentation</div>
</a>
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> Ansible collections
          </a><!--- Based on https://github.com/rtfd/sphinx_rtd_theme/pull/438/files -->

<div class="version">
  
    
  
</div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" class="st-default-search-input" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
              <p class="caption" role="heading"><span class="caption-text">Collections:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Collection Index</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">Collections in the Community Namespace</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Community.Hashi_Vault</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../index.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#communication">Communication</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#changelog">Changelog</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="../index.html#guides">Guides</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#plugin-index">Plugin Index</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Plugin indexes:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index_lookup.html">Index of all Lookup Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../index_module.html">Index of all Modules</a></li>
</ul>
<!-- extra nav elements for Ansible beyond RTD Sphinx Theme -->

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Ansible collections</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Collection Index</a> &raquo;</li>
          <li><a href="../../index.html">Collections in the Community Namespace</a> &raquo;</li>
          <li><a href="../index.html">Community.Hashi_Vault</a> &raquo;</li>
      <li>Lookup guide</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">

  
           <div itemprop="articleBody">
             
  <section id="lookup-guide">
<span id="ansible-collections-community-hashi-vault-docsite-lookup-guide"></span><h1>Lookup guide<a class="headerlink" href="#lookup-guide" title="Permalink to this heading"></a></h1>
<p>This guide is not a comprehensive listing of included lookup plugins and how to use them, rather it is intended to explain the role of the lookup plugins in <code class="docutils literal notranslate"><span class="pre">community.hashi_vault</span></code> and how they are they used, especially when compared to modules of the same name.</p>
<p>For information about the <code class="docutils literal notranslate"><span class="pre">hashi_vault</span></code> lookup specifically, see <a class="reference internal" href="about_hashi_vault_lookup.html#ansible-collections-community-hashi-vault-docsite-about-hashi-vault-lookup"><span class="std std-ref">this page that covers it in detail</span></a>.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#lookups-and-writes" id="id1">Lookups and writes</a></p>
<ul>
<li><p><a class="reference internal" href="#writes-in-vault" id="id2">Writes in Vault</a></p></li>
<li><p><a class="reference internal" href="#how-to-reason-about-when-to-use-lookups" id="id3">How to reason about when to use lookups</a></p></li>
<li><p><a class="reference internal" href="#lookups-and-lazy-templating" id="id4">Lookups and lazy templating</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="lookups-and-writes">
<h2><a class="toc-backref" href="#id1">Lookups and writes</a><a class="headerlink" href="#lookups-and-writes" title="Permalink to this heading"></a></h2>
<p>Most Ansible lookups perform read-only, non-destructive operations. They are run in templating, they generally <em>return</em>  values, and they <strong>do not run differently in check mode</strong> (that is they do the same thing they would in normal mode, even if that means changing something). However, some lookups do change state, sometimes by performing write operations. For example, the <code class="docutils literal notranslate"><span class="pre">password</span></code> <a class="reference external" href="https://docs.ansible.com/ansible/devel/collections/ansible/builtin/password_lookup.html#ansible-collections-ansible-builtin-password-lookup" title="(in Ansible vdevel)"><span class="xref std std-ref">lookup</span></a> writes a generated password to a file, to act as a sort of cache, and the <code class="docutils literal notranslate"><span class="pre">pipe</span></code> <a class="reference external" href="https://docs.ansible.com/ansible/devel/collections/ansible/builtin/pipe_lookup.html#ansible-collections-ansible-builtin-pipe-lookup" title="(in Ansible vdevel)"><span class="xref std std-ref">lookup</span></a> runs an arbitrary shell command so it could easily write or change state.</p>
<section id="writes-in-vault">
<h3><a class="toc-backref" href="#id2">Writes in Vault</a><a class="headerlink" href="#writes-in-vault" title="Permalink to this heading"></a></h3>
<p>Operations that perform writes in Vault are not limited to the obvious ones such as writing a secret value, creating a policy, or enabling a new auth method.</p>
<p>Any operation that creates a token for example, such as any login operation, is also a write; tokens use storage in Vault and having too many active tokens is a common cause of performance problems.</p>
<p>Additionally, some values in Vault can only be “read” at the moment of their creation, and so the only way to retrieve such a value, is to get it as a response from the “write” that created it. A common example is AppRole secret IDs.</p>
<p>The way this relates to Ansible and this collection, is that we may have lookup plugins that either unintuitively perform writes (like <code class="docutils literal notranslate"><span class="pre">vault_login</span></code>), or appear inappropriate to exist as lookups in the first place, like the planned <code class="docutils literal notranslate"><span class="pre">vault_write</span></code> lookup.</p>
<p>The reason for this is that the we often consider these operations to be logical “read” operations, like performing a login, and want to use their results in other expressions.</p>
<p>Something like <code class="docutils literal notranslate"><span class="pre">vault_write</span></code> does not always fit that description, because you could use it in a way that is clearly an explicit write, for example you could create a new policy with the lookup. But there are times it may be appropriate to use it in lookup semantics, like when “retrieving” (really creating) a new secret ID for an approle.</p>
<p>When considering built-in support for auth methods, any auth method other than <code class="docutils literal notranslate"><span class="pre">token</span></code> or <code class="docutils literal notranslate"><span class="pre">none</span></code> makes every lookup, even <code class="docutils literal notranslate"><span class="pre">vault_read</span></code>, into something that’s changing state and performing a write within Vault. This actually applies to many modules too, even when using check mode.</p>
</section>
<section id="how-to-reason-about-when-to-use-lookups">
<h3><a class="toc-backref" href="#id3">How to reason about when to use lookups</a><a class="headerlink" href="#how-to-reason-about-when-to-use-lookups" title="Permalink to this heading"></a></h3>
<p>Because there is potential for writes in any lookup, it is very important to carefully consider when you are using a lookup vs. a module/other plugin. Check mode has no effect on lookups, so there is potential to perform many writes within your check mode run, but maybe sometimes you want that, for example if you’re performing a <code class="docutils literal notranslate"><span class="pre">vault_login</span></code> via lookup to retrieve a token to use in your module calls, you may want that to still happen in check mode so that your module calls can properly check the things they need to.</p>
<p>Some modules that are read focused, like the <code class="docutils literal notranslate"><span class="pre">vault_read</span></code> module, when used with auth other than <code class="docutils literal notranslate"><span class="pre">token</span></code> or <code class="docutils literal notranslate"><span class="pre">none</span></code>, will still perform an internal login even in check mode, so this is still another consideration.</p>
</section>
<section id="lookups-and-lazy-templating">
<h3><a class="toc-backref" href="#id4">Lookups and lazy templating</a><a class="headerlink" href="#lookups-and-lazy-templating" title="Permalink to this heading"></a></h3>
<p>The capacity for lookups to perform writes or change state is exacerbated by Ansible’s “lazy” templating, if not used carefully.</p>
<p>Consider the following example:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">vars</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.vault_login&#39;</span><span class="o">,</span> <span class="nv">auth_method</span><span class="o">=</span><span class="s1">&#39;userpass&#39;</span><span class="o">,</span> <span class="nv">username</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="o">,</span> <span class="nv">password</span><span class="o">=</span><span class="s1">&#39;pass&#39;</span><span class="o">)</span> <span class="o">|</span> <span class="nf">community</span><span class="nv">.hashi_vault.vault_login_token</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;community.hashi_vault.vault_read&#39;</span><span class="o">,</span> <span class="s1">&#39;secrets/data/my-secret&#39;</span><span class="o">,</span> <span class="nv">token</span><span class="o">=</span><span class="nv">token</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">value_a</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">secret.data.data.a</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">value_b</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">secret.data.data.b</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Secret</span><span class="nv"> </span><span class="s">value</span><span class="nv"> </span><span class="s">A</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">&#39;</span><span class="cp">{{</span> <span class="nv">value_a</span> <span class="cp">}}</span><span class="s">&#39;</span><span class="nv"> </span><span class="s">while</span><span class="nv"> </span><span class="s">value</span><span class="nv"> </span><span class="s">B</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">&#39;</span><span class="cp">{{</span> <span class="nv">value_b</span> <span class="cp">}}</span><span class="s">&#39;.&quot;</span><span class="w"></span>
</pre></div>
</div>
<p>Since templating is recursive and evaluated lazily, this will unfortunately <em>not</em> result in a single login, reusing the token to perform a single secret read, which is then used is dictionary lookups.</p>
<p>Instead, evaluation of <code class="docutils literal notranslate"><span class="pre">value_a</span></code> and <code class="docutils literal notranslate"><span class="pre">value_b</span></code> will <em>each</em> cause separate evaluation of <code class="docutils literal notranslate"><span class="pre">secret</span></code>, so that lookup will be performed twice, and <em>each of those lookups</em> will cause a separate evaluation of <code class="docutils literal notranslate"><span class="pre">token</span></code>, which will perform two separate logins, resulting in two tokens being created, and two reads of the exact same secret being performed.</p>
<p>If you combine this with loops, or reusing vars over multiple tasks, you can very quickly multiply the number of requests being made to Vault, and in the case of writes, the number of objects being created.</p>
<p>Tasks can be better for this, since they execute when encountered without being accidentally repeated, and the values they return are static.</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">login</span><span class="w"></span>
<span class="w">  </span><span class="nt">community.hashi_vault.vault_login</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">auth_method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">userpass</span><span class="w"></span>
<span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user</span><span class="w"></span>
<span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pass</span><span class="w"></span>
<span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">login</span><span class="w"></span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">get secret</span><span class="w"></span>
<span class="w">  </span><span class="nt">community.hashi_vault.vault_read</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;</span><span class="cp">{{</span> <span class="nv">login</span> <span class="o">|</span> <span class="nf">community</span><span class="nv">.hashi_vault.vault_login_token</span> <span class="cp">}}</span><span class="s">&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;secrets/data/my-secret&#39;</span><span class="w"></span>
<span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret</span><span class="w"></span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">vars</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">value_a</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">secret.data.data.data.a</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">value_b</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">secret.data.data.data.b</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Secret</span><span class="nv"> </span><span class="s">value</span><span class="nv"> </span><span class="s">A</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">&#39;</span><span class="cp">{{</span> <span class="nv">value_a</span> <span class="cp">}}</span><span class="s">&#39;</span><span class="nv"> </span><span class="s">while</span><span class="nv"> </span><span class="s">value</span><span class="nv"> </span><span class="s">B</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">&#39;</span><span class="cp">{{</span> <span class="nv">value_b</span> <span class="cp">}}</span><span class="s">&#39;.&quot;</span><span class="w"></span>
</pre></div>
</div>
<p>This example will do a single login and secret lookup, even though it is more verbose. It also means the <code class="docutils literal notranslate"><span class="pre">secret</span></code> and <code class="docutils literal notranslate"><span class="pre">login</span></code> variables can be re-used in more tasks without performing additional requests to Vault.</p>
<p>Another thing to consider in both of the examples is that tasks run <em>per host</em>, so you may be multiplying the requests yet again.</p>
<p>In the lookup example, those requests all happen on the controller, and in the module example, they happen on the remote host unless the play or task is targeted locally.</p>
<p>In both cases, you may <em>want</em> to make those requests per host, because some of the variables involved in the lookups may rely on per-host values, like differing authentication, different secret paths, even different Vault servers altogether, or in the case of certain access restrictions, you may need the remote host to make the connection rather than the controller.</p>
<p>But if all of your secret access is intended to be from the controller, and the requests do not depend on host-level variables, you can potentially cut your requests by a lot, by using <code class="docutils literal notranslate"><span class="pre">run_once</span></code>, or making Vault calls in a separate play that only targets <code class="docutils literal notranslate"><span class="pre">localhost</span></code> and using <code class="docutils literal notranslate"><span class="pre">ansible.builtin.set_fact</span></code>, or via other methods.</p>
</section>
</section>
</section>


           </div>
          </div>
          

<footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="about_hashi_vault_lookup.html" class="btn btn-neutral float-left" title="About the hashi_vault lookup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="contributor_guide.html" class="btn btn-neutral float-right" title="Contributor guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ansible contributors.</p>
  </div>

  
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script><!-- extra footer elements for Ansible beyond RTD Sphinx Theme -->

</body>
</html>