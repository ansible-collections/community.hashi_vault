---
- name: Install HashiCorp Vault locally
  block:

    - when: vault_run_https_tests | bool
      vars:
        vault_hostname: localhost
      include_role:
        name: setup_vault_server_cert
    - import_role:
        name: setup_vault_server_download

    - environment:
        # used by vault command
        VAULT_DEV_ROOT_TOKEN_ID: '{{ vault_dev_root_token_id }}'
      block:
        - name: 'Create configuration file'
          template:
            src: vault_config.hcl.j2
            dest: '{{ vault_config_file }}'

        - debug:
            msg: '{{ vault_launch_cmd }} </dev/null >/dev/null 2>&1 &'

        - name: 'Start vault server (dev mode enabled)'
          shell: '{{ vault_launch_cmd }} </dev/null >/dev/null 2>&1 &'
          notify: test_managed_vault_cleanup

        - name: 'Ensure it succeeded'
          block:
            - name: 'Check Vault status'
              environment:
                VAULT_ADDR: '{{ vault_test_server_http }}'
              shell: '{{ vault_cmd }} status'
              register: vault_status
              retries: 10
              delay: 1
              until: vault_status is succeeded


          rescue:
            - name: 'dump the config'
              debug:
                msg: "{{ lookup('file', vault_config_file) }}"

            # vault wasn't up, let's run the launch command with output, which we expect to fail
            - name: 'Re-launch Vault'
              shell: '{{ vault_launch_cmd }}'
              notify: test_managed_vault_cleanup
              # timeout: 10  # when we drop 2.9 support we can enable this just in case
