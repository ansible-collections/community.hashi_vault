- name: "Setup block"
  vars:
    is_default_path: "{{ this_path == default_path }}"
  block:
    - name: 'Enable the JWT auth method'
      vault_ci_enable_auth:
        url: "{{ vault_addr }}"
        token: "{{ vault_dev_root_token_id }}"
        method_type: jwt
        path: '{{ omit if is_default_path else this_path }}'

    - name: 'Configure the JWT auth method'
      command: '{{ vault_cmd }} write auth/{{ this_path }}/config jwt_validation_pubkeys={{ jwt_public_key | quote }}'
      vars:
        jwt_public_key: '{{ lookup("file", "jwt_public.pem") }}'

    - name: 'Create a named role'
      command:
        cmd: '{{ vault_cmd }} write auth/{{ this_path }}/role/test-role -'
        stdin: |-
          {
            "role_type": "jwt",
            "policies": "{{ 'test-policy' if is_default_path else 'alt-policy' }}",
            "user_claim": "sub",
            "bound_audiences": "test"
          } | to_json
