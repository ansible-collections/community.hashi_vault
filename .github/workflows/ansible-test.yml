# README FIRST
# 1. If you don't have unit tests remove that section
# 2. If your collection depends on other collections ensure they are installed, see "Install collection dependencies"
# If you need help please ask in #ansible-devel on Freenode IRC

name: CI
on:
  # Run CI against all pushes (direct commits, also merged PRs), Pull Requests
  push:
  pull_request:
  # Uncomment the following two lines to run CI once per day (at 06:00 UTC)
  # schedule:
  #   - cron: '0 6 * * *'
env:
  NAMESPACE: community
  COLLECTION_NAME: hashi_vault
  ANSIBLE_FORCE_COLOR: true

jobs:
  integration:
    runs-on: ubuntu-latest
    name: I (â’¶${{ matrix.ansible }}+py${{ matrix.python }} | Vault ${{ matrix.vault }})
    strategy:
      fail-fast: false
      matrix:
        ansible:
          - devel
        python:
          - 2.7
          - 3.5
          - 3.6
          - 3.7
          - 3.8
          - 3.9
        vault:
          - 1.6.0
          - 1.5.5
          - 1.4.7
        exclude:
          - ansible: stable-2.9
            python: 3.9

    steps:
      - name: Initialize env vars
        run: |
          COLLECTION_PATH=ansible_collections/${NAMESPACE}/${COLLECTION_NAME}
          LOOKUP_HASHI_VAULT_PATH=${COLLECTION_PATH}/tests/integration/targets/lookup_hashi_vault
          LOOKUP_HASHI_VAULT_BIN=${LOOKUP_HASHI_VAULT_PATH}/lookup_hashi_vault/files/bin
          LOOKUP_HASHI_VAULT_VARS=${LOOKUP_HASHI_VAULT_PATH}/lookup_hashi_vault/vars

          echo "COLLECTION_PATH=${COLLECTION_PATH}" >> ${GITHUB_ENV}
          echo "LOOKUP_HASHI_VAULT_PATH=${LOOKUP_HASHI_VAULT_PATH}" >> ${GITHUB_ENV}
          echo "LOOKUP_HASHI_VAULT_BIN=${LOOKUP_HASHI_VAULT_BIN}" >> ${GITHUB_ENV}
          echo "LOOKUP_HASHI_VAULT_VARS=${LOOKUP_HASHI_VAULT_VARS}" >> ${GITHUB_ENV}

      - name: Check out code
        uses: actions/checkout@v2
        with:
          path: ${{ env.COLLECTION_PATH }}

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Cache vault binaries
        id: cache
        uses: actions/cache@v2
        with:
          path: ${{ env.LOOKUP_HASHI_VAULT_BIN }}
          key: ${{ runner.os }}-vault${{ matrix.vault }}-${{ hashFiles(format('{0}/**', env.LOOKUP_HASHI_VAULT_BIN)) }} # future: include version/arch when configurable

      # removing .gitignore lets the files in those dirs be sent to the container via ansible-test
      # the files/bin dir will contain the vault binary downloaded a few steps later
      # the vars/ dir will be used to write a file overriding role defaults (for Vault version)
      - name: Prepare for Vault version and caching
        run: |
          rm -f "${LOOKUP_HASHI_VAULT_BIN}/.gitignore"
          rm -f "${LOOKUP_HASHI_VAULT_VARS}/.gitignore"
          echo '{ "vault_version": "${{ matrix.vault }}" }' > "${LOOKUP_HASHI_VAULT_VARS}/main.json"

      - name: Install ansible-base (${{ matrix.ansible }})
        run: pip install https://github.com/samdoran/ansible/archive/ci/prefer-venv-over-virtualenv.tar.gz --disable-pip-version-check

      - name: Install collection dependencies
        run: ansible-galaxy collection install community.crypto -p .

      # this will populate files/bin with the selected vault version binary
      - name: Pre-download Vault
        if: steps.cache.outputs.cache-hit != 'true'
        env:
          ANSIBLE_ROLES_PATH: ../
        working-directory: ${{ env.LOOKUP_HASHI_VAULT_PATH }}/playbooks
        run: ansible-playbook "download_vault.yml" -v

      # Run the integration tests
      - name: Run integration test
        run: ansible-test integration -v --color --retry-on-error --continue-on-error --diff --python ${{ matrix.python }} --docker --coverage
        working-directory: ${{ env.COLLECTION_PATH }}

        # ansible-test support producing code coverage date
      - name: Generate coverage report
        run: ansible-test coverage xml -v --requirements --group-by command --group-by version
        working-directory: ${{ env.COLLECTION_PATH }}

      # See the reports at https://codecov.io/gh/GITHUBORG/REPONAME
      - uses: codecov/codecov-action@v1
        with:
          fail_ci_if_error: false
